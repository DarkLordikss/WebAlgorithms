<!doctype html>

<html>
	<head>
		<meta charset="UTF-8">
		<style>
			.basic-plot {
				width: 500px;
				height: 500px;
				border: 1px solid black;
				position: absolute;
			}
			.prime-point {
				width: 10px;
				height: 10px;
				border: 1px solid black;
				background-color: rgba(10,180,10,0.3);
				padding: 2px;
				font-size: 10px;
				position: inherit;
			}
			#iteration_button {
				width: 70px;
				height: 20px;;
				position: absolute;
				left: 520px;
			}
		</style>
		<title> Ant test </title>
	</head>
	<body>
		<h1> Only for testing ant algo </h1>
		<div id="main_plot" class="basic-plot"> 
			<canvas id="plot_lines" width="500" height="500"></canvas>
		</div>
		<input type="button" id="iteration_button" value="Run"> 
		<script type="module">
			import {makePheromoneMatrix, antBasicIteration} from "./antAlgoritmBasic.js";
			let allPoints = new Array();
			let pheromoneMatrix;
			function maxPheromone(pheromoneMatrix) {
				if(!pheromoneMatrix) {
					return;
				}
				let maxValue = 0;
				for(let i = 0; i < pheromoneMatrix.length; i++) {
					for(let j = i + 1; j < pheromoneMatrix.length; j++) {
						if(pheromoneMatrix[i][j].pheromone > maxValue) {
							maxValue = pheromoneMatrix[i][j].pheromone;
						}
					}
				}
				return maxValue;
			}
			function drawPheromones(pheromoneMatrix) {
				if(!pheromoneMatrix) {
					return;
				}
				for(let i = 0; i < pheromoneMatrix.length; i++) {
					for(let j = i + 1; j < pheromoneMatrix.length; j++) {
						let canvas = document.querySelector('canvas');
						let ctx = canvas.getContext('2d');
						ctx.beginPath();
						ctx.moveTo(allPoints[i].x, allPoints[i].y);
						ctx.lineTo(allPoints[j].x, allPoints[j].y);
						let colorVal = 255 * (1-pheromoneMatrix[i][j].pheromone/(maxPheromone(pheromoneMatrix)+0.01));
						if(colorVal<16) {
							colorVal = "0" + (Math.round(colorVal)).toString(16);
						} else {
							colorVal = (Math.round(colorVal)).toString(16);
						}
						ctx.strokeStyle = "#" + colorVal + "FF" + colorVal;
						ctx.lineWidth = 2;
						ctx.stroke();
					}
				}
			}
			function hidePheromones() {
				let canvas = document.querySelector('canvas');
				let ctx = canvas.getContext('2d');
				ctx.clearRect(0, 0, canvas.width, canvas.height);
			}
			function continueOnclick() {
				hidePheromones();
				let iterationResult = antBasicIteration(pheromoneMatrix);
				pheromoneMatrix = iterationResult.matrix;
				drawPheromones(pheromoneMatrix);
			}
			main_plot.onclick = function(event) {
				let newPoint = document.createElement('div');
				let plotCoords = main_plot.getBoundingClientRect();
				let left = event.clientX - plotCoords.left - main_plot.clientLeft - 5;
				let up = event.clientY - plotCoords.top - main_plot.clientTop - 5;
				newPoint.className = "prime-point";
				newPoint.innerHTML = "<span>" + allPoints.length + "</span>";
				newPoint.style.left = left + "px";
				newPoint.style.top = up + "px";
				main_plot.append(newPoint);
				allPoints.push({x: left, y: Math.round(up)});
			}
			iteration_button.onclick = function() {
				main_plot.onclick = ()=>{};
				pheromoneMatrix = makePheromoneMatrix(allPoints);
				drawPheromones(pheromoneMatrix);
				this.value = "Continue";
				this.onclick = continueOnclick;
			}
		</script>
	</body>
</html>